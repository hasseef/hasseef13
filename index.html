<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>منصة حصيف — ملف واحد (Charts + Media)</title>
<style>
:root{
  --green:#0b5b34; --gold:#c9a227; --bg:#f7f6f1; --ink:#111827; --muted:#6b7280; --bd:#e5e7eb; --card:#fff;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.6 system-ui,Segoe UI,Roboto,"Noto Naskh Arabic UI",Arial}
header{background:var(--green);color:#fff;border-bottom:4px solid var(--gold)}
.wrap{max-width:1300px;margin:0 auto;padding:14px 18px}
.brand{display:flex;gap:12px;align-items:center}
.brand svg{height:38px}
.tools{display:flex;gap:8px;flex-wrap:wrap}
select,input,button,textarea{font:inherit;padding:8px 10px;border:1px solid var(--bd);border-radius:10px}
button{background:var(--green);color:#fff;border:none;cursor:pointer}
.btn-ghost{background:#fff;color:var(--green);border:1px solid var(--green)}
.layout{display:grid;grid-template-columns:270px 1fr;gap:14px}
aside{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:12px;position:sticky;top:10px;height:max-content}
main{display:grid;gap:14px}
.card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:14px}
nav a{display:block;color:var(--ink);text-decoration:none;padding:8px 10px;border-radius:10px}
nav a:hover,nav a.active{background:#ecfdf5}
table{width:100%;border-collapse:collapse}
th,td{border-top:1px solid var(--bd);padding:8px;text-align:start;vertical-align:top}
.grid{display:grid;gap:12px}
.grid-2{grid-template-columns:repeat(2,1fr)}
.grid-3{grid-template-columns:repeat(3,1fr)}
.kpi{display:flex;gap:10px;align-items:center}
.kpi .v{font-weight:800;font-size:22px}
.muted{color:var(--muted)}
.pill{display:inline-flex;gap:6px;align-items:center;background:#f0fdf4;border:1px solid #bbf7d0;color:#065f46;padding:2px 8px;border-radius:999px;font-size:12px}
.hr{height:1px;background:var(--bd);margin:10px 0}
.qr{border:1px dashed var(--ink);width:92px;height:92px;display:flex;align-items:center;justify-content:center;font-size:11px}
.warn{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;border-radius:10px;padding:8px}
.badge{background:#eef2ff;border:1px solid #c7d2fe;color:#3730a3;padding:2px 6px;border-radius:7px;font-size:12px}
.media-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
.media-card{border:1px solid var(--bd);border-radius:12px;overflow:hidden;background:#fff}
.media-card header{padding:8px 10px;background:#fafafa;border-bottom:1px solid var(--bd);color:#111}
.media-card .content{padding:8px}
.media-thumb{width:100%;height:130px;object-fit:cover;background:#f2f2f2;display:block}
.media-actions{display:flex;justify-content:space-between;gap:6px;margin-top:6px}
footer{color:var(--muted);text-align:center;padding:18px}
@media (max-width:1000px){ .layout{grid-template-columns:1fr} aside{position:static} }
</style>
</head>
<body>
<header>
  <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
    <div class="brand">
      <svg viewBox="0 0 280 80" aria-label="HASIF"><rect width="280" height="80" fill="#0b5b34"/><rect y="70" width="280" height="4" fill="#c9a227"/><text x="20" y="50" font-size="28" font-family="Arial" fill="#fff">HASIF | منصة حصيف</text></svg>
      <div>
        <div style="font-weight:800">منصة حصيف — نموذج شامل (ملف واحد)</div>
        <div class="muted">حلول صائبة يُقترح فعلها — نسخة متصفح للتجربة والتعليم</div>
      </div>
    </div>
    <div class="tools">
      <select id="roleSel" title="نوع الحساب">
        <option value="government">القطاع الحكومي</option>
        <option value="development_authority">هيئة التطوير</option>
        <option value="region">إمارة المنطقة</option>
        <option value="private">القطاع الخاص</option>
        <option value="nonprofit">القطاع غير الربحي</option>
        <option value="university">الجامعات</option>
        <option value="donor">المانح</option>
        <option value="individual">الأفراد</option>
        <option value="admin">إدارة المنصة</option>
      </select>
      <button id="langBtn" class="btn-ghost">English</button>
      <button id="exportBtn" class="btn-ghost">تصدير JSON</button>
      <input id="importFile" type="file" accept="application/json" hidden>
      <button id="importBtn" class="btn-ghost">استيراد JSON</button>
      <button id="seedBtn" class="btn-ghost">إدخال عينات</button>
      <button id="resetBtn" class="btn-ghost">مسح البيانات</button>
    </div>
  </div>
</header>

<div class="wrap layout">
  <aside>
    <h3 style="margin:0 0 8px">القوائم الرئيسية</h3>
    <small id="roleLabel" class="muted">—</small>
    <nav id="sideNav" style="margin-top:10px"></nav>
    <div class="hr"></div>
    <div class="warn"><strong>تنبيه:</strong> هذا نموذج متصفح فقط (بدون خادم/نفاذ/توقيع رقمي/تكاملات). البيانات تُحفظ محليًا.</div>
  </aside>

  <main id="main">
    <!-- لوحة المؤشرات -->
    <section class="card" id="sec-dashboard">
      <h2>لوحة المؤشرات</h2>
      <div id="kpis" class="grid grid-3"></div>
      <div class="hr"></div>
      <!-- Canvas chart -->
      <div class="grid grid-2">
        <div>
          <h3>رسم بياني — ملخص المؤشرات</h3>
          <canvas id="kpiCanvas" width="560" height="280" style="max-width:100%;border:1px solid var(--bd);border-radius:12px;background:#fff"></canvas>
          <small class="muted">يُحدّث تلقائيًا عند إضافة بيانات.</small>
        </div>
        <div>
          <span class="pill">رؤية 2030</span>
          <span class="pill">حوكمة</span>
          <span class="pill">تمكين مجتمعي</span>
          <div class="hr"></div>
          <div class="muted">تلميح: أضف مشروعًا/حلاً/فعالية وسترى التغيّر على الرسم.</div>
        </div>
      </div>
    </section>

    <!-- التحديات -->
    <section class="card sec" data-tags="government development_authority region admin">
      <h2>التحديات</h2>
      <form id="chForm" class="grid grid-3">
        <input name="ownerOrgId" placeholder="Org ID (مثال org-gov-001)" required>
        <input name="title" placeholder="عنوان التحدي" required>
        <input name="domain" placeholder="المجال (تقنية/صحة/ثقافة)" required>
        <button>إضافة</button>
      </form>
      <table><thead><tr><th>العنوان</th><th>المجال</th><th>الجهة</th><th>الحالة</th><th>إغلاق</th></tr></thead>
      <tbody id="chT"></tbody></table>
    </section>

    <!-- الحلول -->
    <section class="card sec" data-tags="government private nonprofit university individual development_authority admin">
      <h2>الحلول</h2>
      <form id="soForm" class="grid grid-3">
        <input name="challengeId" placeholder="Challenge ID (ch-001)" required>
        <input name="proposerOrgId" placeholder="Org ID (خاص/جامعة/غير ربحي/أفراد)" required>
        <input name="summary" placeholder="ملخص الحل" required>
        <button>تقديم</button>
      </form>
      <table><thead><tr><th>الحل</th><th>للتحدي</th><th>المُقدّم</th><th>تقييم</th></tr></thead>
      <tbody id="soT"></tbody></table>
    </section>

    <!-- المشاريع -->
    <section class="card sec" data-tags="government development_authority region admin private nonprofit university donor">
      <h2>المشاريع</h2>
      <form id="prForm" class="grid grid-3">
        <input name="ownerOrgId" placeholder="Org ID" required>
        <input name="visionGoal" placeholder="هدف الرؤية" required>
        <input name="budget" type="number" placeholder="الميزانية" required>
        <button>إضافة</button>
      </form>
      <table><thead><tr><th>المعرف</th><th>الجهة</th><th>الهدف</th><th>الميزانية</th><th>الحالة</th><th>تحديث الحالة</th></tr></thead>
      <tbody id="prT"></tbody></table>
    </section>

    <!-- الرعايات/المحفظة -->
    <section class="card sec" data-tags="donor private nonprofit government development_authority admin">
      <h2>التمويل والرعايات والمحفظة</h2>
      <div class="grid grid-2">
        <div class="card">
          <h3>المحفظة</h3>
          <div class="grid grid-3">
            <input id="walletOrg" placeholder="Org ID (org-donor-001)">
            <button id="walletLoad" class="btn-ghost">عرض الرصيد</button>
            <span id="walletView" class="muted">—</span>
          </div>
          <div class="hr"></div>
          <div class="grid grid-3">
            <select id="txType"><option value="credit">إيداع</option><option value="debit">سحب</option></select>
            <input id="txAmount" type="number" placeholder="المبلغ">
            <input id="txRef" placeholder="المرجع">
            <button id="txDo">تنفيذ</button>
          </div>
        </div>
        <div class="card">
          <h3>الرعايات</h3>
          <form id="spForm" class="grid grid-3">
            <select id="spTarget"><option value="project">Project</option><option value="event">Event</option></select>
            <input name="targetId" placeholder="pr-*/ev-*">
            <input name="donorOrgId" placeholder="Donor Org">
            <input name="amount" type="number" placeholder="المبلغ">
            <button>اعتماد رعاية</button>
          </form>
          <table><thead><tr><th>#</th><th>الهدف</th><th>المانح</th><th>المبلغ</th><th>الحالة</th></tr></thead><tbody id="spT"></tbody></table>
        </div>
      </div>
    </section>

    <!-- فعاليات ومتحدثون -->
    <section class="card sec" data-tags="government private nonprofit university development_authority admin">
      <h2>الفعاليات والمتحدثون</h2>
      <form id="evForm" class="grid grid-3">
        <input name="orgId" placeholder="Org ID" required>
        <input name="title" placeholder="عنوان الفعالية" required>
        <input name="date" type="date" required>
        <input name="speakers" placeholder="متحدثون (أسماء مفصولة بفواصل)">
        <button>إنشاء</button>
      </form>
      <table><thead><tr><th>المعرف</th><th>العنوان</th><th>التاريخ</th><th>الجهة</th><th>متحدثون</th></tr></thead><tbody id="evT"></tbody></table>
    </section>

    <!-- التطوع/التدريب/الاستشارات -->
    <section class="card sec" data-tags="nonprofit university private individual government admin">
      <h2>Engagements: التطوع / التدريب / الاستشارات</h2>
      <form id="enForm" class="grid grid-3">
        <select name="type"><option value="volunteer">تطوع</option><option value="training">تدريب</option><option value="consulting">استشارة</option></select>
        <input name="orgId" placeholder="Org ID" required>
        <input name="hours" type="number" placeholder="الساعات (للتطوع/التدريب)">
        <input name="fee" type="number" placeholder="الأتعاب (للاستشارة)">
        <button>تسجيل</button>
      </form>
      <table><thead><tr><th>#</th><th>النوع</th><th>الجهة</th><th>ساعات</th><th>أتعاب</th></tr></thead><tbody id="enT"></tbody></table>
    </section>

    <!-- الاتفاقيات والشهادات -->
    <section class="card sec" data-tags="government private nonprofit university development_authority admin">
      <h2>الاتفاقيات الرقمية والشهادات</h2>
      <div class="grid grid-2">
        <div class="card">
          <h3>اتفاقية رقمية (قابلة للطباعة)</h3>
          <form id="agForm" class="grid grid-3">
            <input name="partyA" placeholder="الطرف الأول" required>
            <input name="partyB" placeholder="الطرف الثاني" required>
            <input name="title"  placeholder="عنوان الاتفاقية" required>
            <button>توليد اتفاقية</button>
          </form>
          <div id="agOut" class="muted">—</div>
        </div>
        <div class="card">
          <h3>شهادة مشاركة/تدريب/استشارة (قابلة للطباعة)</h3>
          <form id="certForm" class="grid grid-3">
            <input name="name" placeholder="الاسم" required>
            <input name="org"  placeholder="الجهة" required>
            <select name="kind"><option>تطوع</option><option>تدريب</option><option>استشارة</option></select>
            <input name="hours" type="number" placeholder="الساعات/المدة">
            <button>توليد شهادة</button>
          </form>
          <div id="certOut" class="muted">—</div>
        </div>
      </div>
    </section>

    <!-- الإعلام والتوثيق (مع رفع وسائط) -->
    <section class="card sec" data-tags="government private nonprofit university development_authority region admin">
      <h2>الإعلام والتوثيق (صور/فيديو)</h2>
      <form id="mdForm" class="grid grid-3">
        <select name="targetType"><option>project</option><option>event</option></select>
        <input name="targetId" placeholder="pr-*/ev-*">
        <input name="headline" placeholder="عنوان خبر/تغطية">
        <input name="url" placeholder="رابط (اختياري)">
        <input id="mediaFile" type="file" accept="image/*,video/*">
        <button>إضافة</button>
      </form>
      <div class="hr"></div>
      <div id="mediaGrid" class="media-grid"></div>
      <table style="margin-top:10px"><thead><tr><th>#</th><th>الموضوع</th><th>العنوان</th><th>الرابط</th></tr></thead><tbody id="mdT"></tbody></table>
    </section>

    <!-- الحاضنات والمسرّعات -->
    <section class="card sec" data-tags="development_authority university private nonprofit admin">
      <h2>الحاضنات والمسرّعات</h2>
      <form id="ibForm" class="grid grid-3">
        <input name="name" placeholder="اسم الحاضنة/المسرّعة" required>
        <select name="kind"><option>حاضنة</option><option>مسرّعة</option></select>
        <input name="ownerOrgId" placeholder="Org ID" required>
        <button>إنشاء</button>
      </form>
      <table><thead><tr><th>#</th><th>الاسم</th><th>النوع</th><th>الجهة</th></tr></thead><tbody id="ibT"></tbody></table>
    </section>

    <!-- التدقيق -->
    <section class="card sec" data-tags="admin government development_authority region">
      <h2>سجل التدقيق (Audit)</h2>
      <table><thead><tr><th>الوقت</th><th>الكيان</th><th>الحدث</th><th>التفاصيل</th></tr></thead><tbody id="auT"></tbody></table>
    </section>

    <!-- نبذة -->
    <section class="card">
      <h2>حول هذا النموذج</h2>
      <p class="muted">هذا ملف واحد للتجربة والتعليم. <strong>ليس نسخة إنتاج</strong>. خصائص الإنتاج (نفاذ/SSO، RBAC خادمي، PostgreSQL/Prisma، توقيع رقمي وQR حي، تكاملات حكومية/دفع) خارج المتصفح.</p>
    </section>
  </main>
</div>

<footer>© HASIF Demo — ملف واحد | Prototype شامل (Charts + Media)</footer>

<script>
/* =========================
   بيانات، قوائم، RBAC واجهوي
========================= */
const LS_KEY='hasif:data:v3';
const seed = {
  organizations:[
    {id:'org-gov-001',name:'وزارة التنمية',type:'gov',region:'الرياض'},
    {id:'org-priv-001',name:'شركة ألف',type:'private',region:'الرياض'},
    {id:'org-np-001',name:'جمعية بناء',type:'nonprofit',region:'الشرقية'},
    {id:'org-uni-001',name:'جامعة الملك المستقبل',type:'university',region:'مكة'},
    {id:'org-donor-001',name:'صندوق الأثر الوطني',type:'donor',region:'الرياض'},
    {id:'org-region-001',name:'إمارة منطقة الرياض',type:'region',region:'الرياض'},
    {id:'org-dev-001',name:'هيئة تطوير الرياض',type:'dev_auth',region:'الرياض'}
  ],
  challenges:[
    {id:'ch-001',ownerOrgId:'org-gov-001',title:'خفض فجوة المهارات الرقمية',domain:'تقنية',status:'open',createdAt:ts()},
    {id:'ch-002',ownerOrgId:'org-gov-001',title:'زيادة فرص التطوع الصحي',domain:'صحة',status:'open',createdAt:ts()},
    {id:'ch-003',ownerOrgId:'org-gov-001',title:'تنشيط الفعاليات الثقافية',domain:'ثقافة',status:'open',createdAt:ts()}
  ],
  solutions:[
    {id:'sol-001',challengeId:'ch-001',proposerOrgId:'org-uni-001',summary:'مسار تدريبي معتمد + تدريب تعاوني مع شركات تقنية',score:4.5},
    {id:'sol-002',challengeId:'ch-002',proposerOrgId:'org-np-001',summary:'عيادات متنقلة يديرها متطوعون مع نظام حجز رقمي',score:4.2},
    {id:'sol-003',challengeId:'ch-003',proposerOrgId:'org-priv-001',summary:'رعاية فعاليات ثقافية في الأحياء + مسار متحدثين',score:4.0}
  ],
  projects:[
    {id:'pr-001',ownerOrgId:'org-gov-001',visionGoal:'تحسين جودة الحياة',status:'in_progress',budget:250000,sourceSolution:'sol-002',createdAt:ts()},
    {id:'pr-002',ownerOrgId:'org-gov-001',visionGoal:'اقتصاد مزدهر',status:'funded',budget:400000,sourceSolution:'sol-001',createdAt:ts()}
  ],
  sponsorships:[{id:'sp-001',target:{type:'project',id:'pr-002'},donorOrgId:'org-donor-001',amount:200000,status:'approved'}],
  wallets:[{id:'w-1',orgId:'org-donor-001',balance:1000000},{id:'w-2',orgId:'org-priv-001',balance:250000}],
  transactions:[
    {id:'tx-001',walletId:'w-1',type:'credit',amount:1000000,ref:'funding-topup',ts:ts()},
    {id:'tx-002',walletId:'w-1',type:'debit',amount:200000,ref:'sp-001',ts:ts()}
  ],
  events:[{id:'ev-001',orgId:'org-priv-001',title:'منتدى المسؤولية الاجتماعية',date:datePlus(20),speakers:['د. نهى','م. سالم'],approvals:['org-gov-001']}],
  engagements:[
    {id:'en-001',type:'volunteer',orgId:'org-np-001',hours:120},
    {id:'en-002',type:'training',orgId:'org-uni-001',hours:40},
    {id:'en-003',type:'consulting',orgId:'org-priv-001',fee:15000}
  ],
  media:[],
  incubators:[],
  kpi:[{id:'kpi-001',entityType:'project',entityId:'pr-001',kpiKey:'beneficiaries',value:5000,period:'2025-Q4'}],
  audit:[]
};
const menus = {
  government:["لوحة المؤشرات","التحديات","الحلول","المشاريع","الشراكات/الاتفاقيات","الفعاليات","المؤشرات/الرؤية","التقارير"],
  development_authority:["لوحة هيئة التطوير","خارطة المشاريع الإستراتيجية","التصاريح التنموية","الحاضنات/المسرعات","المؤشرات الإقليمية","التقارير"],
  region:["لوحة المنطقة","المشاريع المناطقية","التصاريح","الرعايات الرسمية","المؤشرات المحلية","التقارير"],
  private:["لوحة CSR","المشاريع الممولة","الرعايات","الفعاليات","الاستشارات","المرافق","المحفظة","التقارير"],
  nonprofit:["لوحة المبادرات","المشاريع","التطوع","الفعاليات","التمويل/الرعايات","المحفظة","التقارير"],
  university:["لوحة الجامعة","التعزيز العلمي","التدريب","التدريب التعاوني","الاستشارات","البرامج","التقارير"],
  donor:["لوحة المانح","المحفظة","المشاريع المرشحة","التمويلات/الرعايات","الأثر","التقارير المالية"],
  individual:["ملفي","تقديم حل","فرص التطوع","التدريب","التحدث/التدريب","الوظائف","شهاداتي"],
  admin:["لوحة النظام","الحسابات والصلاحيات","الإشعارات","الدعم الفني","التدقيق","التقارير المجمعة","الإعدادات"]
};
const RBAC = {
  government:["challenges","solutions","projects","events","agreements","kpi","audit","finance","media","incubators"],
  development_authority:["projects","events","kpi","agreements","incubators","media","audit","finance"],
  region:["projects","kpi","media","audit"],
  private:["solutions","events","engagements","finance","media"],
  nonprofit:["solutions","projects","events","engagements","finance","media"],
  university:["solutions","events","engagements","incubators","media"],
  donor:["projects","finance","kpi"],
  individual:["solutions","engagements"],
  admin:["*"]
};
function ts(){return new Date().toISOString()}
function datePlus(d){const x=new Date();x.setDate(x.getDate()+d);return x.toISOString().slice(0,10)}
function dbLoad(){const raw=localStorage.getItem(LS_KEY); if(!raw){ dbSave(seed); return JSON.parse(JSON.stringify(seed)); } try{ return JSON.parse(raw);}catch{ dbSave(seed); return JSON.parse(JSON.stringify(seed)); }}
function dbSave(d){localStorage.setItem(LS_KEY, JSON.stringify(d));}
function audit(entity,action,details){const d=dbLoad(); d.audit.push({id:id('au'),ts:ts(),entity,action,details}); dbSave(d);}
function id(p){return p+'-'+Math.random().toString(36).slice(2,8)}
const Q = sel => document.querySelector(sel);
const QA = sel => [...document.querySelectorAll(sel)];

/* =========================
   تبديل اللغة RTL/LTR (واجهوي)
========================= */
let lang='ar';
Q('#langBtn').onclick=()=>{
  const html=document.documentElement;
  if(lang==='ar'){lang='en'; html.lang='en'; html.dir='ltr'; Q('#langBtn').textContent='العربية';}
  else{lang='ar'; html.lang='ar'; html.dir='rtl'; Q('#langBtn').textContent='English';}
};

/* =========================
   استيراد/تصدير/Seed/Reset
========================= */
Q('#exportBtn').onclick=()=>{
  const blob=new Blob([localStorage.getItem(LS_KEY)||'{}'],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='hasif_data.json'; a.click(); URL.revokeObjectURL(a.href);
};
Q('#importBtn').onclick=()=>Q('#importFile').click();
Q('#importFile').onchange=(e)=>{const f=e.target.files[0]; if(!f) return; f.text().then(txt=>{try{dbSave(JSON.parse(txt)); renderAll();}catch{alert('ملف غير صالح');}})};
Q('#seedBtn').onclick=()=>{dbSave(seed); audit('system','seed',{}); renderAll();};
Q('#resetBtn').onclick=()=>{ if(confirm('مسح جميع البيانات؟')){ localStorage.removeItem(LS_KEY); dbSave(seed); audit('system','reset',{}); renderAll(); } };

/* =========================
   بناء القائمة الجانبية حسب الدور (RBAC)
========================= */
const roleSel=Q('#roleSel'), sideNav=Q('#sideNav'), roleLabel=Q('#roleLabel');
roleSel.onchange=()=>{ buildSide(); filterSections(); renderAll(); };
function buildSide(){
  const role=roleSel.value; roleLabel.textContent='الحساب: '+role;
  const list=menus[role]||[];
  sideNav.innerHTML='';
  const aDash=document.createElement('a'); aDash.textContent='لوحة المؤشرات'; aDash.href="#sec-dashboard"; aDash.classList.add('active'); sideNav.appendChild(aDash);
  list.forEach((label,i)=>{
    const anchor=document.createElement('a');
    anchor.textContent=label;
    const map = {
      "التحديات":"challenges","الحلول":"solutions","المشاريع":"projects","المؤشرات/الرؤية":"kpi",
      "الشراكات/الاتفاقيات":"agreements","الفعاليات":"events","التقارير":"audit",
      "لوحة هيئة التطوير":"kpi", "خارطة المشاريع الإستراتيجية":"projects", "التصاريح التنموية":"agreements",
      "الحاضنات/المسرعات":"incubators", "المؤشرات الإقليمية":"kpi",
      "المشاريع المناطقية":"projects", "التصاريح":"agreements","الرعايات الرسمية":"finance","المؤشرات المحلية":"kpi",
      "لوحة CSR":"kpi","المشاريع الممولة":"projects","الرعايات":"finance","الاستشارات":"engagements","المرافق":"media","المحفظة":"finance",
      "لوحة المبادرات":"kpi","التطوع":"engagements","التمويل/الرعايات":"finance",
      "لوحة الجامعة":"kpi","التعزيز العلمي":"solutions","التدريب":"engagements","التدريب التعاوني":"engagements","الاستشارات":"engagements","البرامج":"events",
      "لوحة المانح":"kpi","المشاريع المرشحة":"projects","التمويلات/الرعايات":"finance","الأثر":"kpi","التقارير المالية":"audit",
      "ملفي":"kpi","تقديم حل":"solutions","فرص التطوع":"engagements","التدريب":"engagements","التحدث/التدريب":"events","الوظائف":"media","شهاداتي":"agreements",
      "لوحة النظام":"kpi","الحسابات والصلاحيات":"media","الإشعارات":"media","الدعم الفني":"media","التدقيق":"audit","التقارير المجمعة":"audit","الإعدادات":"media"
    };
    const secId = 'sec-'+(map[label]||'kpi');
    anchor.href='#'+secId;
    anchor.onclick = (e)=>{ QA('nav a').forEach(x=>x.classList.remove('active')); e.target.classList.add('active'); };
    sideNav.appendChild(anchor);
  });
}
function filterSections(){
  const role=roleSel.value;
  const allowed = RBAC[role]||[];
  QA('.sec').forEach(sec=>{
    const tags = (sec.getAttribute('data-tags')||'').split(/\s+/);
    const show = allowed.includes('*') || tags.some(t=>allowed.includes(mapTag(t)));
    sec.style.display = show ? '' : 'none';
  });
  function mapTag(t){ return t; }
}

/* =========================
   مؤشرات (KPIs) + الرسم البياني
========================= */
function renderKPIs(){
  const d=dbLoad();
  const totalProjects=d.projects.length;
  const funded=d.projects.filter(p=>['funded','completed'].includes(p.status)).length;
  const budget = d.projects.reduce((s,p)=>s+(+p.budget||0),0);
  const challenges=d.challenges.length;
  const solutions=d.solutions.length;
  const engagements=d.engagements.length;
  const items=[
    {t:'المشاريع Projects',v:totalProjects},
    {t:'ممول/مكتمل Funded/Completed',v:funded},
    {t:'الميزانية الكلية SAR',v:budget.toLocaleString()},
    {t:'التحديات',v:challenges},
    {t:'الحلول',v:solutions},
    {t:'Engagements',v:engagements}
  ];
  const el=Q('#kpis'); el.innerHTML='';
  items.forEach(it=>{
    const c=document.createElement('div'); c.className='card kpi';
    c.innerHTML=`<svg width="24" height="24" viewBox="0 0 24 24"><path fill="#0a4d2c" d="M9 16.2 5.5 12.7 4 14.2 9 19l11-11-1.5-1.5"/></svg>
      <div><div style="font-weight:700">${it.t}</div><div class="v">${it.v}</div></div>`;
    el.appendChild(c);
  });
  drawKpiChart({projects:totalProjects,funded,budget,solutions,engagements,challenges});
}
function drawKpiChart(data){
  const ctx=Q('#kpiCanvas').getContext('2d');
  const w=ctx.canvas.width, h=ctx.canvas.height;
  ctx.clearRect(0,0,w,h);
  // محاور بسيطة
  ctx.fillStyle="#111"; ctx.font="12px system-ui";
  const labels=["Projects","Funded","Budget(K)","Solutions","Engagements","Challenges"];
  const values=[data.projects,data.funded,Math.round((+data.budget||0)/1000),data.solutions,data.engagements,data.challenges];
  const max = Math.max(...values, 5);
  const pad=40, barW= (w - pad*2) / values.length - 16;
  // grid
  ctx.strokeStyle="#eee";
  for(let i=0;i<=5;i++){ const y=pad + (h-pad*2)*(i/5); ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(w-pad,y); ctx.stroke(); }
  // bars
  values.forEach((v,i)=>{
    const x = pad + i*(barW+16) + 8;
    const y = h - pad;
    const bh = (h - pad*2) * (v/max);
    ctx.fillStyle = "#0b5b34";
    ctx.fillRect(x, y-bh, barW, bh);
    // value
    ctx.fillStyle="#111"; ctx.textAlign="center";
    ctx.fillText(String(v), x+barW/2, y-bh-6);
    // label
    ctx.fillStyle="#555"; ctx.save(); ctx.translate(x+barW/2, y+14); ctx.rotate(-Math.PI/8);
    ctx.fillText(labels[i], 0, 0); ctx.restore();
  });
  // frame
  ctx.strokeStyle="#c9a227"; ctx.strokeRect(1,1,w-2,h-2);
}

/* =========================
   CRUD مبسّط للأقسام
========================= */
const QV = id => Q(id).value;
function renderChallenges(){
  const d=dbLoad(), tb=Q('#chT'); tb.innerHTML='';
  d.challenges.forEach(ch=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${ch.title}</td><td>${ch.domain}</td><td>${ch.ownerOrgId}</td><td>${ch.status}</td>
    <td><button class="btn-ghost" data-id="${ch.id}">إغلاق</button></td>`;
    tr.querySelector('button').onclick=()=>{ ch.status='closed'; dbSave(d); audit('challenge','close',{id:ch.id}); renderChallenges(); renderKPIs(); };
    tb.appendChild(tr);
  });
}
Q('#chForm').onsubmit=(e)=>{e.preventDefault(); const d=dbLoad(); const f=Object.fromEntries(new FormData(e.target));
  const ch={id:id('ch'),status:'open',createdAt:ts(),...f}; d.challenges.push(ch); dbSave(d); audit('challenge','create',ch); e.target.reset(); renderChallenges(); renderKPIs();};

function renderSolutions(){
  const d=dbLoad(), tb=Q('#soT'); tb.innerHTML='';
  d.solutions.forEach(so=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${so.summary}</td><td>${so.challengeId}</td><td>${so.proposerOrgId}</td>
      <td><input type="number" min="0" max="5" value="${so.score||0}" style="width:80px"></td>`;
    tr.querySelector('input').onchange=(ev)=>{ so.score=+ev.target.value; dbSave(d); audit('solution','score',{id:so.id,score:so.score}); renderKPIs();};
    tb.appendChild(tr);
  });
}
Q('#soForm').onsubmit=(e)=>{e.preventDefault(); const d=dbLoad(); const f=Object.fromEntries(new FormData(e.target));
  const so={id:id('sol'),score:0,...f}; d.solutions.push(so); dbSave(d); audit('solution','create',so); e.target.reset(); renderSolutions(); renderKPIs();};

function renderProjects(){
  const d=dbLoad(), tb=Q('#prT'); tb.innerHTML='';
  d.projects.forEach(pr=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${pr.id}</td><td>${pr.ownerOrgId}</td><td>${pr.visionGoal}</td><td>${(+pr.budget||0).toLocaleString()}</td><td>${pr.status}</td>
    <td><select data-id="${pr.id}">
      <option value="pending" ${pr.status==='pending'?'selected':''}>قيد التقييم</option>
      <option value="in_progress" ${pr.status==='in_progress'?'selected':''}>قيد التنفيذ</option>
      <option value="funded" ${pr.status==='funded'?'selected':''}>ممول</option>
      <option value="completed" ${pr.status==='completed'?'selected':''}>مكتمل</option>
    </select></td>`;
    tr.querySelector('select').onchange=(ev)=>{ pr.status=ev.target.value; dbSave(d); audit('project','status',{id:pr.id,status:pr.status}); renderProjects(); renderKPIs(); };
    tb.appendChild(tr);
  });
}
Q('#prForm').onsubmit=(e)=>{e.preventDefault(); const d=dbLoad(); const f=Object.fromEntries(new FormData(e.target));
  const pr={id:id('pr'),status:'pending',createdAt:ts(),budget:+f.budget||0,...f}; d.projects.push(pr); dbSave(d); audit('project','create',pr); e.target.reset(); renderProjects(); renderKPIs();};

/* محفظة ورعايات */
function walletView(){ const d=dbLoad(); const org=QV('#walletOrg'); const v=Q('#walletView');
  const w=d.wallets.find(x=>x.orgId===org)||{orgId:org,balance:0}; v.textContent=`Org: ${org||'—'} — Balance: ${(w.balance||0).toLocaleString()}`;}
Q('#walletLoad').onclick=walletView;
Q('#txDo').onclick=()=>{const d=dbLoad(); const org=QV('#walletOrg'); if(!org) return alert('أدخل Org ID');
  let w=d.wallets.find(x=>x.orgId===org); if(!w){w={id:id('w'),orgId:org,balance:0}; d.wallets.push(w);}
  const type=QV('#txType'), amount=+(QV('#txAmount')||0), ref=QV('#txRef')||'-';
  if(type==='credit') w.balance+=amount; else w.balance-=amount;
  const tx={id:id('tx'),walletId:w.id,type,amount,ref,ts:ts()}; d.transactions.push(tx); dbSave(d); audit('wallet','tx',tx); walletView(); renderKPIs();
};
function renderSponsorships(){const d=dbLoad(), tb=Q('#spT'); tb.innerHTML='';
  d.sponsorships.forEach((sp,i)=>{const tr=document.createElement('tr'); const t=(sp.target?.type+':'+sp.target?.id)||'-';
    tr.innerHTML=`<td>${i+1}</td><td>${t}</td><td>${sp.donorOrgId}</td><td>${(+sp.amount||0).toLocaleString()}</td><td>${sp.status||'approved'}</td>`; tb.appendChild(tr);});}
Q('#spForm').onsubmit=(e)=>{e.preventDefault(); const d=dbLoad(); const f=Object.fromEntries(new FormData(e.target));
  const sp={id:id('sp'),target:{type:QV('#spTarget'),id:f.targetId},donorOrgId:f.donorOrgId,amount:+f.amount||0,status:'approved'}; d.sponsorships.push(sp);
  dbSave(d); audit('sponsorship','approve',sp); e.target.reset(); renderSponsorships(); renderKPIs();};

/* فعاليات */
function renderEvents(){const d=dbLoad(),tb=Q('#evT'); tb.innerHTML='';
  d.events.forEach(ev=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${ev.id}</td><td>${ev.title}</td><td>${ev.date}</td><td>${ev.orgId}</td><td>${(ev.speakers||[]).join(', ')}</td>`; tb.appendChild(tr);});}
Q('#evForm').onsubmit=(e)=>{e.preventDefault(); const d=dbLoad(); const f=Object.fromEntries(new FormData(e.target));
  const ev={id:id('ev'),orgId:f.orgId,title:f.title,date:f.date,speakers:(f.speakers||'').split(',').map(s=>s.trim()).filter(Boolean),approvals:[]};
  d.events.push(ev); dbSave(d); audit('event','create',ev); e.target.reset(); renderEvents(); renderKPIs();};

/* التطوع/التدريب/الاستشارات */
function renderEngagements(){const d=dbLoad(),tb=Q('#enT'); tb.innerHTML='';
  d.engagements.forEach(en=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${en.id}</td><td>${en.type}</td><td>${en.orgId}</td><td>${en.hours||'-'}</td><td>${en.fee||'-'}</td>`; tb.appendChild(tr);});}
Q('#enForm').onsubmit=(e)=>{e.preventDefault(); const d=dbLoad(); const f=Object.fromEntries(new FormData(e.target));
  const en={id:id('en'),...f,hours:+(f.hours||0)||undefined,fee:+(f.fee||0)||undefined}; d.engagements.push(en); dbSave(d); audit('engagement','create',en); e.target.reset(); renderEngagements(); renderKPIs();};

/* اتفاقيات وشهادات (طباعة) */
function printableAgreement({partyA,partyB,title}){const vId=id('agr'),dt=new Date().toISOString().slice(0,10);
  const html=`<div style="font-family:system-ui;width:800px;margin:0 auto">
    <div style="background:#0b5b34;color:#fff;padding:16px;border-bottom:4px solid #c9a227">
      <h2 style="margin:0">اتفاقية رقمية | Digital Agreement</h2><div>HASIF — Demo</div></div>
    <div style="padding:16px;border:1px solid #eee;border-top:none">
      <p><strong>العنوان:</strong> ${title}</p><p><strong>الأطراف:</strong> ${partyA} — ${partyB}</p>
      <ol><li>الامتثال والحوكمة الوطنية.</li><li>خصوصية البيانات.</li><li>الصلاحيات وفق الدور.</li><li>قياس الأثر والتقارير.</li></ol>
      <p><strong>التاريخ:</strong> ${dt} — <strong>المعرّف:</strong> ${vId}</p>
      <div style="display:flex;gap:16px;align-items:center"><div class="qr">QR</div><div class="muted">التحقق: https://hasif.example/verify/${vId}</div></div>
      <div style="margin-top:28px;display:flex;gap:40px"><div>توقيع الطرف الأول: ________</div><div>توقيع الطرف الثاني: ________</div></div>
    </div></div>`;
  return {id:vId,html};
}
Q('#agForm').onsubmit=(e)=>{e.preventDefault(); const f=Object.fromEntries(new FormData(e.target));
  const {id:vid,html}=printableAgreement(f); Q('#agOut').innerHTML=`<div class="card">${html}<div class="hr"></div><button onclick="printNode(this.closest('.card'))">طباعة</button></div>`;
  audit('agreement','render',{id:vid,parties:[f.partyA,f.partyB]});
};
function printableCertificate({name,org,kind,hours}){const vId=id('cert'),dt=new Date().toISOString().slice(0,10);
  const html=`<div style="font-family:system-ui;width:800px;margin:0 auto">
    <div style="background:#0b5b34;color:#fff;padding:16px;border-bottom:4px solid #c9a227">
      <h2 style="margin:0">شهادة ${kind}</h2><div>HASIF — Demo</div></div>
    <div style="padding:16px;border:1px solid #eee;border-top:none">
      <p>تشهد منصة حصيف بأن <strong>${name}</strong> قد شارك عبر <strong>${kind}</strong> لدى <strong>${org}</strong>.</p>
      <p>المدة/الساعات: <strong>${hours||'-'}</strong> — التاريخ: <strong>${dt}</strong> — المعرّف: <strong>${vId}</strong></p>
      <div style="display:flex;gap:16px;align-items:center"><div class="qr">QR</div><div class="muted">التحقق: https://hasif.example/verify/${vId}</div></div>
    </div></div>`;
  return {id:vId,html};
}
Q('#certForm').onsubmit=(e)=>{e.preventDefault(); const f=Object.fromEntries(new FormData(e.target));
  const {id:vid,html}=printableCertificate(f); Q('#certOut').innerHTML=`<div class="card">${html}<div class="hr"></div><button onclick="printNode(this.closest('.card'))">طباعة</button></div>`;
  audit('certificate','render',{id:vid,name:f.name,org:f.org,kind:f.kind});
};
function printNode(node){const w=open('','_blank'); w.document.write(`<!doctype html><meta charset="utf-8"><title>Print</title>${node.innerHTML}`); w.document.close(); w.focus(); w.print();}

/* الإعلام مع رفع وسائط */
function renderMedia(){
  const d=dbLoad(), tb=Q('#mdT'); tb.innerHTML='';
  const grid=Q('#mediaGrid'); grid.innerHTML='';
  d.media.forEach((m,i)=>{
    // جدول نصي
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${m.targetType}:${m.targetId||'-'}</td><td>${m.headline||'-'}</td><td>${m.url?`<a target="_blank" href="${m.url}">رابط</a>`:'—'}</td>`;
    tb.appendChild(tr);
    // كروت وسائط
    const card=document.createElement('div'); card.className='media-card';
    const hdr=document.createElement('header'); hdr.textContent=m.headline||'—'; card.appendChild(hdr);
    const content=document.createElement('div'); content.className='content';
    if(m.blob && m.mime && m.mime.startsWith('image/')){
      const img=document.createElement('img'); img.className='media-thumb'; img.src=m.blob; img.alt=m.headline||'media';
      content.appendChild(img);
    }else if(m.blob && m.mime && m.mime.startsWith('video/')){
      const vid=document.createElement('video'); vid.className='media-thumb'; vid.src=m.blob; vid.controls=true;
      content.appendChild(vid);
    }else{
      const div=document.createElement('div'); div.className='media-thumb'; div.style.display='flex'; div.style.alignItems='center'; div.style.justifyContent='center'; div.textContent='—';
      content.appendChild(div);
    }
    const actions=document.createElement('div'); actions.className='media-actions';
    const aOpen=document.createElement('a'); aOpen.className='btn-ghost'; aOpen.style.padding='6px 10px'; aOpen.textContent='فتح';
    if(m.url){ aOpen.href=m.url; aOpen.target='_blank'; } else if(m.blob){ aOpen.href=m.blob; aOpen.target='_blank'; } else { aOpen.href='#'; aOpen.onclick=e=>e.preventDefault(); }
    const btnDel=document.createElement('button'); btnDel.className='btn-ghost'; btnDel.textContent='حذف';
    btnDel.onclick=()=>{ const d2=dbLoad(); d2.media = d2.media.filter(x=>x.id!==m.id); dbSave(d2); audit('media','delete',{id:m.id}); renderMedia(); };
    actions.appendChild(aOpen); actions.appendChild(btnDel);
    content.appendChild(actions); card.appendChild(content); grid.appendChild(card);
  });
}
Q('#mdForm').onsubmit=async (e)=>{
  e.preventDefault(); const d=dbLoad(); const f=Object.fromEntries(new FormData(e.target));
  const file = Q('#mediaFile').files[0];
  let blob=null, mime=null;
  if(file){
    // تحويل إلى dataURL للتخزين المحلي
    blob = await fileToDataURL(file);
    mime = file.type || '';
  }
  const item={id:id('md'), ...f, blob, mime};
  d.media.push(item); dbSave(d); audit('media','add', {id:item.id, mime, withFile: Boolean(blob)});
  e.target.reset(); Q('#mediaFile').value='';
  renderMedia();
};
function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

/* الحاضنات */
function renderIncubators(){const d=dbLoad(),tb=Q('#ibT'); tb.innerHTML='';
  d.incubators.forEach((ib,i)=>{const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${ib.name}</td><td>${ib.kind}</td><td>${ib.ownerOrgId}</td>`; tb.appendChild(tr);});}
Q('#ibForm').onsubmit=(e)=>{e.preventDefault(); const d=dbLoad(); const f=Object.fromEntries(new FormData(e.target));
  const ib={id:id('ib'),...f}; d.incubators.push(ib); dbSave(d); audit('incubator','create',ib); e.target.reset(); renderIncubators();};

/* التدقيق */
function renderAudit(){const d=dbLoad(),tb=Q('#auT'); tb.innerHTML='';
  d.audit.slice(-300).reverse().forEach(a=>{const tr=document.createElement('tr');
    tr.innerHTML=`<td>${a.ts}</td><td>${a.entity}</td><td>${a.action}</td><td class="muted"><pre style="white-space:pre-wrap;margin:0">${escapeHTML(JSON.stringify(a.details,null,2))}</pre></td>`; tb.appendChild(tr);});}
function escapeHTML(s){return (s||'').replace(/[<>&]/g,m=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[m]))}

/* تشغيل أولي */
function renderAll(){
  renderKPIs();
  renderChallenges();
  renderSolutions();
  renderProjects();
  renderSponsorships();
  renderEvents();
  renderEngagements();
  renderMedia();
  renderIncubators();
  renderAudit();
}
function init(){ if(!localStorage.getItem(LS_KEY)) dbSave(seed); buildSide(); filterSections(); renderAll(); }
window.addEventListener('load', init);
</script>
</body>
</html>
